<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>InstaNews</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Helvetica, Arial, sans-serif; }
        body { background: #fafafa; }
        .post-image { aspect-ratio: 1 / 1; object-fit: cover; width: 100%; }
        .post-image.vertical { aspect-ratio: auto; max-height: 600px; }
        .video-container { position: relative; width: 100%; aspect-ratio: 16 / 9; background: #000; }
        .video-container iframe { width: 100%; height: 100%; border: none; }
        .story { width: 60px; height: 80px; border-radius: 12px; background: #e0e0e0; cursor: pointer; position: relative; overflow: hidden; }
        .story img { width: 100%; height: 100%; object-fit: cover; }
        .story-ring { border: 2px solid #ff6b6b; }
        .grid-item { aspect-ratio: 1 / 1; }
        .grid-item img { width: 100%; height: 100%; object-fit: cover; }
    </style>
</head>
<body class="bg-gray-50">
    <div class="flex justify-center min-h-screen">
        <div class="w-full max-w-md bg-white">
            <!-- Header -->
            <header class="sticky top-0 z-40 border-b border-gray-200 px-4 py-3">
                <h1 class="text-2xl font-bold italic">InstaNews</h1>
            </header>

            <!-- Stories -->
            <div id="storiesContainer" class="border-b border-gray-200 px-4 py-3 flex gap-2 overflow-x-auto">
                <!-- Historias se cargan aqui -->
            </div>

            <!-- Feed -->
            <main id="feed" class="pb-20">
                <!-- Posts se cargan aqui -->
            </main>

            <!-- Bottom Navigation -->
            <nav class="fixed bottom-0 w-full max-w-md bg-white border-t border-gray-200 flex justify-around h-12">
                <button onclick="goHome()" class="flex-1 flex items-center justify-center text-2xl" title="Inicio">üè†</button>
                <button onclick="toggleSearch()" class="flex-1 flex items-center justify-center text-2xl" title="Buscar">üîç</button>
                <button onclick="toggleLiked()" class="flex-1 flex items-center justify-center text-2xl" title="Favoritos">‚ù§Ô∏è</button>
                <button onclick="showProfile()" class="flex-1 flex items-center justify-center text-2xl" title="Perfil">üë§</button>
            </nav>
        </div>
    </div>

    <!-- Search Modal -->
    <dialog id="searchModal" class="rounded-lg p-6 max-w-sm" backdrop>
        <h2 class="text-xl font-bold mb-4">Buscar</h2>
        <input type="text" id="searchInput" placeholder="Buscar noticias..." class="w-full border rounded-lg p-2 mb-4">
        <div id="searchResults" class="space-y-2 max-h-64 overflow-y-auto"></div>
        <button onclick="document.getElementById('searchModal').close()" class="w-full bg-gray-200 p-2 rounded mt-4">Cerrar</button>
    </dialog>

    <!-- Profile Grid Modal -->
    <dialog id="profileModal" class="backdrop:bg-black/50 rounded-lg max-w-2xl w-full max-h-[90vh]" backdrop>
        <div class="p-6">
            <h2 class="text-2xl font-bold mb-2">Perfil</h2>
            <div class="flex items-center gap-4 mb-6">
                <div class="w-16 h-16 rounded-full bg-gradient-to-br from-purple-400 to-pink-600"></div>
                <div>
                    <p class="font-bold" id="profileAuthor">Noticias</p>
                    <p class="text-gray-500 text-sm" id="profileHandle">@noticias</p>
                </div>
            </div>
            <h3 class="font-bold mb-3">Tus Favoritos</h3>
            <div id="profileGrid" class="grid grid-cols-3 gap-2">
                <!-- Grid de noticias favoritas -->
            </div>
            <form method="dialog">
                <button class="w-full bg-gray-200 p-2 rounded mt-4">Cerrar</button>
            </form>
        </div>
    </dialog>

    <script>
        const REPO_OWNER = 'RandyCorrea';
        const REPO_NAME = 'noticias';
        let newsData = [];
        let likedNews = JSON.parse(localStorage.getItem('likedNews') || '[]');
        let currentAuthor = 'Noticias';
        let currentHandle = '@noticias';
        let currentAuthorAvatar = 'N';

        document.addEventListener('DOMContentLoaded', loadNews);

        async function loadNews() {
            try {
                const response = await fetch(`https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/news-data.json`);
                if (!response.ok) return;
                const data = await response.json();
                const content = decodeURIComponent(escape(atob(data.content)));
                const parsedData = JSON.parse(content);
                
                newsData = parsedData.news || [];
                const config = parsedData.config || {};
                
                currentAuthor = config.author || 'Noticias';
                currentHandle = config.handle || '@noticias';
                currentAuthorAvatar = (config.author || 'Noticias').substring(0, 2).toUpperCase();
                
                document.getElementById('profileAuthor').textContent = currentAuthor;
                document.getElementById('profileHandle').textContent = currentHandle;
                
                renderStories(parsedData.stories || []);
                renderFeed();
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('feed').innerHTML = '<div class="p-4 text-center text-gray-500">Error cargando noticias</div>';
            }
        }

        function renderStories(stories) {
            const container = document.getElementById('storiesContainer');
            if (!stories || stories.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.innerHTML = stories.map(story => `
                <div class="story story-ring" onclick="openStory('${story.id}')">
                    <img src="${story.image}" alt="Story">
                </div>
            `).join('');
        }

        function renderFeed() {
            const feed = document.getElementById('feed');
            feed.innerHTML = newsData.map((post, idx) => {
                const isLiked = likedNews.includes(post.id);
                const isVideo = post.videoEmbed || post.videoUrl;
                
                return `
                    <article class="border-b border-gray-200">
                        <!-- Header -->
                        <div class="px-4 py-3 flex justify-between items-center">
                            <div class="flex items-center gap-2">
                                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-purple-400 to-pink-600 flex items-center justify-center text-white font-bold">${currentAuthorAvatar}</div>
                                <div>
                                    <p class="font-bold text-sm">${post.author || currentAuthor}</p>
                                    <p class="text-xs text-gray-500">${post.handle || currentHandle} ‚Ä¢ ${formatTime(post.id)}</p>
                                </div>
                            </div>
                            <button class="text-gray-500" onclick="alert('M√°s opciones')">‚ãØ</button>
                        </div>

                        <!-- Media -->
                        ${isVideo ? `
                            <div class="video-container">
                                ${post.videoEmbed || `<iframe src="${post.videoUrl}" allowfullscreen></iframe>`}
                            </div>
                        ` : post.image ? `
                            <img src="${post.image}" class="post-image ${post.imageHeight && post.imageHeight !== post.imageWidth ? 'vertical' : ''}" onclick="openPost('${post.slug}')" style="cursor: pointer;">
                        ` : ''}

                        <!-- Actions -->
                        <div class="px-4 pt-3 pb-2 flex justify-between">
                            <div class="flex gap-4">
                                <button onclick="toggleLike('${post.id}')" class="text-2xl">${isLiked ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                                <button onclick="openPost('${post.slug}')" class="text-2xl">üí¨</button>
                                <button onclick="sharePost('${post.slug}')" class="text-2xl">‚ÜóÔ∏è</button>
                            </div>
                            <button class="text-2xl">üîñ</button>
                        </div>

                        <!-- Likes -->
                        <div class="px-4 py-1 font-bold text-sm">${likedNews.includes(post.id) ? '‚úì Te gust√≥ esto' : 'S√© el primero en comentar'}</div>

                        <!-- Caption -->
                        <div class="px-4 pb-3 text-sm">
                            <p><span class="font-bold">${post.author || currentAuthor}</span> ${post.title}</p>
                            <p class="text-gray-600 mt-1">${post.excerpt}</p>
                            <button onclick="openPost('${post.slug}')" class="text-gray-500 text-xs mt-2 hover:text-gray-700 font-bold">LEER M√ÅS</button>
                        </div>
                    </article>
                `;
            }).join('');
        }

        function formatTime(timestamp) {
            const now = new Date();
            const post = new Date(timestamp);
            const diff = Math.floor((now - post) / 1000);
            
            if (diff < 60) return 'ahora';
            if (diff < 3600) return Math.floor(diff / 60) + 'm';
            if (diff < 86400) return Math.floor(diff / 3600) + 'h';
            if (diff < 604800) return Math.floor(diff / 86400) + 'd';
            return Math.floor(diff / 604800) + 's';
        }

        function toggleLike(postId) {
            if (likedNews.includes(postId)) {
                likedNews = likedNews.filter(id => id !== postId);
            } else {
                likedNews.push(postId);
            }
            localStorage.setItem('likedNews', JSON.stringify(likedNews));
            renderFeed();
            updateProfileGrid();
        }

        function toggleSearch() {
            document.getElementById('searchModal').showModal();
            document.getElementById('searchInput').focus();
            document.getElementById('searchInput').addEventListener('input', performSearch);
        }

        function performSearch() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const results = newsData.filter(post => 
                post.title.toLowerCase().includes(query) || 
                post.excerpt.toLowerCase().includes(query)
            );
            
            const resultsDiv = document.getElementById('searchResults');
            resultsDiv.innerHTML = results.map(post => `
                <div class="border rounded-lg p-2 cursor-pointer hover:bg-gray-50" onclick="openPost('${post.slug}'); document.getElementById('searchModal').close();">
                    <p class="font-bold text-sm">${post.title}</p>
                    <p class="text-xs text-gray-600">${post.excerpt.substring(0, 80)}...</p>
                </div>
            `).join('');
        }

        function toggleLiked() {
            showProfile();
        }

        function showProfile() {
            updateProfileGrid();
            document.getElementById('profileModal').showModal();
        }

        function updateProfileGrid() {
            const grid = document.getElementById('profileGrid');
            const likedPosts = newsData.filter(post => likedNews.includes(post.id));
            
            grid.innerHTML = likedPosts.map(post => `
                <div class="grid-item cursor-pointer" onclick="openPost('${post.slug}')">
                    ${post.image ? `<img src="${post.image}" alt="${post.title}">` : '<div class="bg-gradient-to-br from-purple-400 to-pink-600 w-full h-full"></div>'}
                </div>
            `).join('');
        }

        function openPost(slug) {
            window.location.href = `posts/${slug}.html`;
        }

        function sharePost(slug) {
            const url = `${window.location.origin}${window.location.pathname}../posts/${slug}.html`;
            navigator.clipboard.writeText(url);
            alert('Enlace copiado');
        }

        function openStory(storyId) {
            alert('Story: ' + storyId);
        }

        function goHome() {
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
