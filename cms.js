const CMS_PASSWORD='admin2025',OWNER='RandyCorrea',REPO='noticias';let allNews=[],imgW=0,imgH=0,currentImageFile=null;window.addEventListener('DOMContentLoaded',()=>{if(sessionStorage.getItem('cms_logged_in')==='true')showCMS();document.getElementById('passwordInput').addEventListener('keypress',e=>{if(e.key==='Enter')checkPassword();});document.addEventListener('paste',handlePaste);const dropZone=document.getElementById('dropZone');dropZone.addEventListener('click',()=>document.getElementById('image').click());dropZone.addEventListener('dragover',e=>{e.preventDefault();dropZone.classList.add('drag-over');});dropZone.addEventListener('dragleave',()=>dropZone.classList.remove('drag-over'));dropZone.addEventListener('drop',handleDrop);});function handlePaste(e){const items=e.clipboardData?.items;if(!items)return;for(let i=0;i<items.length;i++){if(items[i].type.indexOf('image')!==-1){e.preventDefault();const file=items[i].getAsFile();processImageFile(file);break;}}}function handleDrop(e){e.preventDefault();document.getElementById('dropZone').classList.remove('drag-over');const files=e.dataTransfer.files;if(files.length>0&&files[0].type.indexOf('image')!==-1){processImageFile(files[0]);}}function processImageFile(file){currentImageFile=file;const reader=new FileReader();reader.onload=e=>{const img=new Image();img.onload=function(){imgW=this.width;imgH=this.height;document.getElementById('imagePreview').innerHTML=`<button class="remove-image" onclick="removeImage()">√ó</button><img src="${e.target.result}"><div style="color:#666;font-size:.9em;margin-top:10px">Dimensiones: ${imgW}x${imgH}px | ${(file.size/1024/1024).toFixed(2)}MB</div>`;};img.src=e.target.result;};reader.readAsDataURL(file);}function removeImage(){currentImageFile=null;imgW=0;imgH=0;document.getElementById('imagePreview').innerHTML='';document.getElementById('image').value='';}document.getElementById('image').addEventListener('change',function(e){const file=e.target.files[0];if(file)processImageFile(file);});function checkPassword(){if(document.getElementById('passwordInput').value===CMS_PASSWORD){sessionStorage.setItem('cms_logged_in','true');showCMS();}else{document.getElementById('loginError').style.display='block';}}function showCMS(){document.getElementById('loginScreen').style.display='none';document.getElementById('cmsScreen').style.display='block';loadNewsList();}function logout(){sessionStorage.removeItem('cms_logged_in');location.reload();}function switchTab(tab){document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));event.target.classList.add('active');document.getElementById(tab+'Tab').classList.add('active');if(tab==='manage')loadNewsList();}function previewNews(){const t=document.getElementById('title').value,c=document.getElementById('content').value;if(!t||!c)return alert('Completa t√≠tulo y contenido');const w=window.open('','_blank');w.document.write(`<h1>${t}</h1><div style="white-space:pre-wrap">${c}</div>`);}document.getElementById('newsForm').addEventListener('submit',async function(e){e.preventDefault();const title=document.getElementById('title').value,content=document.getElementById('content').value,token=document.getElementById('token').value;if(!currentImageFile){alert('Imagen obligatoria. Pega con Ctrl+V o arrastra.');return;}showMessage('Publicando...','success');try{const ts=Date.now(),date=new Date().toLocaleDateString('es-ES',{year:'numeric',month:'long',day:'numeric',hour:'2-digit',minute:'2-digit'});const imageBase64=await fileToBase64(currentImageFile),imageName=`img_${ts}.jpg`;showMessage('Subiendo imagen...','success');await uploadToGitHub(OWNER,REPO,`images/${imageName}`,imageBase64.split(',')[1],`Imagen: ${imageName}`,token);const excerpt=content.substring(0,150).replace(/"/g,"'"),readTime=Math.ceil(content.split(' ').length/200);const htmlFile=`posts/${ts}.html`,fullImgUrl=`https://${OWNER}.github.io/${REPO}/images/${imageName}`,articleUrl=`https://${OWNER}.github.io/${REPO}/${htmlFile}`;const newsData={id:ts,title:title,content:content,excerpt:excerpt,image:`images/${imageName}`,imageWidth:imgW,imageHeight:imgH,date:date,timestamp:ts,url:htmlFile};showMessage('Generando p√°gina...','success');const articleHTML=`<!DOCTYPE html>\n<html lang="es">\n<head>\n<meta charset="UTF-8">\n<meta name="viewport" content="width=device-width,initial-scale=1.0">\n<title>${title} | Portal de Noticias</title>\n<meta name="description" content="${excerpt}">\n<meta property="og:type" content="article">\n<meta property="og:site_name" content="Portal de Noticias">\n<meta property="og:title" content="${title}">\n<meta property="og:description" content="${excerpt}">\n<meta property="og:image" content="${fullImgUrl}">\n<meta property="og:image:width" content="${imgW}">\n<meta property="og:image:height" content="${imgH}">\n<meta property="og:url" content="${articleUrl}">\n<meta name="twitter:card" content="summary_large_image">\n<meta name="twitter:title" content="${title}">\n<meta name="twitter:description" content="${excerpt}">\n<meta name="twitter:image" content="${fullImgUrl}">\n<link href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&family=Inter:wght@400;600&display=swap" rel="stylesheet">\n<style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:'Inter',sans-serif;background:#fff;color:#1a1a1a;line-height:1.6}.header{border-bottom:1px solid #e6e6e6;padding:20px 0;position:sticky;top:0;background:rgba(255,255,255,.95);backdrop-filter:blur(10px);z-index:100}.header-content{max-width:740px;margin:0 auto;padding:0 24px;display:flex;justify-content:space-between;align-items:center}.site-title{font-family:'Merriweather',serif;font-size:1.5em;font-weight:900;color:#1a1a1a;text-decoration:none}.back-link{color:#6b6b6b;text-decoration:none;font-size:.95em}.back-link:hover{color:#1a1a1a}.article{max-width:740px;margin:60px auto;padding:0 24px}.article-title{font-family:'Merriweather',serif;font-size:3em;font-weight:700;line-height:1.2;margin-bottom:24px;color:#1a1a1a}.article-meta{display:flex;align-items:center;gap:16px;margin-bottom:40px;padding-bottom:24px;border-bottom:1px solid #e6e6e6;color:#6b6b6b;font-size:.95em}.article-image{width:100%;max-height:500px;object-fit:cover;margin-bottom:40px;border-radius:4px}.article-text{font-family:'Merriweather',serif;font-size:1.25em;line-height:1.8;color:#1a1a1a;white-space:pre-wrap;word-wrap:break-word}.share-buttons{margin-top:60px;padding-top:40px;border-top:1px solid #e6e6e6;display:flex;gap:15px;flex-wrap:wrap;align-items:center}.share-btn{padding:10px 20px;background:#f5f5f5;border:none;border-radius:20px;cursor:pointer;font-size:.9em;text-decoration:none;color:#1a1a1a}.share-btn:hover{background:#e0e0e0}@media(max-width:768px){.article-title{font-size:2em}.article-text{font-size:1.1em}}</style>\n</head>\n<body>\n<header class="header"><div class="header-content"><a href="../index.html" class="site-title">Portal de Noticias</a><a href="../index.html" class="back-link">‚Üê Inicio</a></div></header>\n<article class="article">\n<h1 class="article-title">${title}</h1>\n<div class="article-meta"><span>${date}</span><span>¬∑</span><span>${readTime} min de lectura</span></div>\n<img src="../${newsData.image}" alt="${title}" class="article-image">\n<div class="article-text">${content}</div>\n<div class="share-buttons"><span style="color:#6b6b6b">Compartir:</span><button class="share-btn" onclick="navigator.clipboard.writeText(location.href);alert('Copiado')">üîó Copiar</button><a href="https://twitter.com/intent/tweet?text=${encodeURIComponent(title)}&url=${encodeURIComponent(articleUrl)}" target="_blank" class="share-btn">üê¶ Twitter</a><a href="https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(articleUrl)}" target="_blank" class="share-btn">üëç Facebook</a><a href="https://wa.me/?text=${encodeURIComponent(title+' - '+articleUrl)}" target="_blank" class="share-btn">üí¨ WhatsApp</a></div>\n</article>\n</body>\n</html>`;showMessage('Subiendo HTML...','success');await uploadToGitHub(OWNER,REPO,htmlFile,btoa(unescape(encodeURIComponent(articleHTML))),`Nueva: ${title}`,token);showMessage('Actualizando √≠ndice...','success');let existingNews=[];try{const r=await fetch(`https://raw.githubusercontent.com/${OWNER}/${REPO}/main/news-data.json`);if(r.ok)existingNews=await r.json();}catch(e){}existingNews.unshift(newsData);await uploadToGitHub(OWNER,REPO,'news-data.json',btoa(unescape(encodeURIComponent(JSON.stringify(existingNews,null,2)))),`Actualizar √≠ndice`,token,true);showMessage(`‚úÖ Publicado! ${articleUrl}`,'success');document.getElementById('newsForm').reset();removeImage();}catch(error){showMessage('‚ùå Error: '+error.message,'error');}});async function loadNewsList(){const container=document.getElementById('newsList');container.innerHTML='<div class="loading">Cargando...</div>';try{const r=await fetch(`https://raw.githubusercontent.com/${OWNER}/${REPO}/main/news-data.json?t=`+Date.now());if(!r.ok)throw new Error('Sin noticias');allNews=await r.json();if(allNews.length===0){container.innerHTML='<p style="text-align:center;color:#666">No hay noticias</p>';return;}container.innerHTML='<div class="news-list">'+allNews.map(n=>`<div class="news-item"><div class="news-item-header"><div><h3>${n.title}</h3><div class="date">üìÖ ${n.date}</div></div><div class="news-actions"><button class="btn-small btn-copy" onclick="copyURL('${n.url||'posts/'+n.id+'.html'}')">üîó URL</button><button class="btn-small btn-delete" onclick="deleteNews(${n.id})">üóëÔ∏è Eliminar</button></div></div><div class="excerpt">${n.content.substring(0,200)}...</div></div>`).join('')+'</div>';}catch(e){container.innerHTML='<p style="text-align:center;color:#666">Error</p>';}}function copyURL(url){navigator.clipboard.writeText(`https://${OWNER}.github.io/${REPO}/${url}`);alert('‚úÖ Copiada');}async function deleteNews(id){const token=document.getElementById('manageToken').value;if(!token)return alert('Ingresa token');if(!confirm('¬øEliminar?'))return;try{await uploadToGitHub(OWNER,REPO,'news-data.json',btoa(unescape(encodeURIComponent(JSON.stringify(allNews.filter(n=>n.id!=id),null,2)))),`Eliminar ${id}`,token,true);alert('‚úÖ Eliminada');loadNewsList();}catch(e){alert('‚ùå Error: '+e.message);}}function fileToBase64(file){return new Promise((resolve,reject)=>{const reader=new FileReader();reader.onload=()=>resolve(reader.result);reader.onerror=reject;reader.readAsDataURL(file);});}async function uploadToGitHub(owner,repo,path,content,message,token,update=false){let sha='';if(update){try{const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{headers:{'Authorization':`token ${token}`}});if(r.ok)sha=(await r.json()).sha;}catch(e){}}const body={message,content,branch:'main'};if(sha)body.sha=sha;const r=await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`,{method:'PUT',headers:{'Authorization':`token ${token}`,'Content-Type':'application/json'},body:JSON.stringify(body)});if(!r.ok)throw new Error((await r.json()).message||'Error');return r.json();}function showMessage(message,type){const div=document.getElementById('statusMessage');div.textContent=message;div.className=`status-message ${type}`;div.style.display='block';if(type==='success')setTimeout(()=>div.style.display='none',8000);}